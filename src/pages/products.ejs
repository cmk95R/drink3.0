<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestión de Productos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .sidebar {
        min-height: 100vh;
        background-color: #343a40;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 0.75rem 1rem;
      }
      .sidebar a:hover {
        background-color: #495057;
      }
      .product-image {
        max-width: 80px;
        max-height: 80px;
        object-fit: cover;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="px-3 py-2 text-bg-dark border-bottom">
        <div class="container">
          <div
            class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start"
          >
            <a
              href="/"
              class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none"
            >
              <svg
                class="bi me-2"
                width="40"
                height="32"
                role="img"
                aria-label="Bootstrap"
              >
                <use xlink:href="#bootstrap"></use>
              </svg>
            </a>
            <ul
              class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"
            >
              <li><a href="#" class="nav-link text-secondary">Home</a></li>
              <li><a href="#" class="nav-link text-white">Dashboard</a></li>
              <li><a href="#" class="nav-link text-white">Ordenes</a></li>
              <li><a href="#" class="nav-link text-white">Productos</a></li>
              <li><a href="#" class="nav-link text-white">Profile</a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav
          class="col-md-3 col-lg-2 sidebar d-flex flex-column p-3 text-white"
        >
          <h2 class="fs-4 mb-4">Productos</h2>
          <a href="/products">Lista de Productos</a>
          <!-- Botón para abrir el modal -->
          <button
            type="button"
            class="btn btn-primary mt-2"
            data-bs-toggle="modal"
            data-bs-target="#modalAgregarProducto"
          >
            Agregar Producto
          </button>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 col-lg-10 p-4">
          <h1 class="mb-4">Lista de Productos</h1>

          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
              <thead class="table-dark">
                <tr>
                  <th>Imagen</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Categoría</th>
                  <th>Disponible</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach(product => { %>
                <tr>
                  <td>
                    <% if (product.image) { %>
                    <img
                      class="product-image"
                      src="/uploads/<%= product.image %>"
                      alt="Imagen de <%= product.name %>"
                    />
                    <% } else { %>
                    <span class="text-muted">Sin imagen</span>
                    <% } %>
                  </td>
                  <td><%= product.name %></td>
                  <td>$<%= product.price.toFixed(2) %></td>
                  <td><%= product.stock %></td>
                  <td><%= product.category %></td>
                  <td><%= product.isAvailable ? 'Sí' : 'No' %></td>
                  <td>
                    <div class="d-flex justify-content-center gap-2">
                      <button
                        type="button"
                        class="btn btn-sm btn-warning btn-edit"
                        data-bs-toggle="modal"
                        data-bs-target="#editProductModal"
                        data-id="<%= product._id %>"
                        data-name="<%= product.name %>"
                        data-price="<%= product.price %>"
                        data-stock="<%= product.stock %>"
                        data-category="<%= product.category %>"
                        data-description="<%= product.description %>"
                        data-image="<%= product.image ? product.image : '' %>"
                        data-isavailable="<%= product.isAvailable %>"
                      >
                        Editar
                      </button>
                      <form method="POST" action="/products/<%= product._id %>?_method=DELETE" class="delete-form">
                      <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Agregar Productos-->
    <div
      class="modal fade"
      id="modalAgregarProducto"
      tabindex="-1"
      aria-labelledby="modalAgregarProductoLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form
            id="formAgregarProducto"
            action="/products/add"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="modal-header">
              <h5 class="modal-title" id="modalAgregarProductoLabel">
                Agregar Producto
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="name" class="form-label">Nombre</label>
                <input type="text" name="name" class="form-control" required />
              </div>
              <div class="mb-3">
                <label for="price" class="form-label">Precio</label>
                <input
                  type="number"
                  name="price"
                  step="0.01"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="stock" class="form-label">Stock</label>
                <input
                  type="number"
                  name="stock"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="category" class="form-label">Categoría</label>
                <select name="category" class="form-select" required>
                  <option value="vino">Vino</option>
                  <option value="cerveza">Cerveza</option>
                  <option value="whisky">Whisky</option>
                  <option value="vodka">Vodka</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="isAvailable" class="form-label">¿Disponible?</label>
                <select name="isAvailable" class="form-select">
                  <option value="true">Sí</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="image" class="form-label">Imagen</label>
                <input type="file" name="image" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-success">
                Guardar Producto
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Modal Editar Productos-->  
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editProductForm" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_method" value="PUT" />
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProductModalLabel">Editar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editName" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="editName" name="name" required />
          </div>
          <div class="mb-3">
            <label for="editPrice" class="form-label">Precio:</label>
            <input type="number" step="0.01" class="form-control" id="editPrice" name="price" required />
          </div>
          <div class="mb-3">
            <label for="editStock" class="form-label">Stock:</label>
            <input type="number" class="form-control" id="editStock" name="stock" required />
          </div>
          <div class="mb-3">
            <label for="editCategory" class="form-label">Categoría:</label>
            <select class="form-select" id="editCategory" name="category" required>
              <option value="vino">Vino</option>
              <option value="cerveza">Cerveza</option>
              <option value="whisky">Whisky</option>
              <option value="vodka">Vodka</option>
              <option value="otros">Otros</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Descripción:</label>
            <textarea class="form-control" id="editDescription" name="description"></textarea>
          </div>
          <div class="mb-3">
            <label>Imagen actual:</label>
            <div id="currentImageContainer" class="mb-2"></div>
            <label for="editImage" class="form-label">Cambiar Imagen:</label>
            <input type="file" class="form-control" id="editImage" name="image" accept="image/*" />
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" id="editIsAvailable" name="isAvailable" />
            <label class="form-check-label" for="editIsAvailable">Disponible</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
    </div>



    <!-- Script de Bootstrap para funcionamiento del modal -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Script Agregar Productos-->  
    <script>
      document
        .getElementById("formAgregarProducto")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const form = e.target;
          const formData = new FormData(form);

          try {
            const res = await fetch("/products/add", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            if (res.ok) {
              Swal.fire({
                icon: "success",
                title: "Producto guardado",
                text: data.message,
                confirmButtonText: "Aceptar",
              }).then(() => {
                window.location.href = "/products";
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: data.message || "Ocurrió un error al guardar el producto",
              });
            }
          } catch (err) {
            console.error(err);
            Swal.fire({
              icon: "error",
              title: "Error de red",
              text: "No se pudo conectar con el servidor",
            });
          }
        });
    </script>

    <!-- Script Editar Productos-->  
    <script>
  const editProductModal = document.getElementById('editProductModal');
  const editProductForm = document.getElementById('editProductForm');

  editProductModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget; // Botón que disparó el modal
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');
    const price = button.getAttribute('data-price');
    const stock = button.getAttribute('data-stock');
    const category = button.getAttribute('data-category');
    const description = button.getAttribute('data-description');
    const image = button.getAttribute('data-image');
    const isAvailable = button.getAttribute('data-isavailable') === 'true';

    // Setear el action del form para que vaya a /products/edit/:id
    editProductForm.action = `/products/edit/${id}?_method=PUT`;

    // Cargar los valores en los campos
    document.getElementById('editName').value = name;
    document.getElementById('editPrice').value = price;
    document.getElementById('editStock').value = stock;
    document.getElementById('editCategory').value = category;
    document.getElementById('editDescription').value = description;
    document.getElementById('editIsAvailable').checked = isAvailable;

    // Mostrar imagen actual
    const imgContainer = document.getElementById('currentImageContainer');
    if(image){
      imgContainer.innerHTML = `<img src="/uploads/${image}" alt="Imagen actual" width="100" />`;
    } else {
      imgContainer.innerHTML = 'No hay imagen';
    }
  });
    </script>

        
    <!-- Script Editar Productos Alert-->  
    <script>
  
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const editSuccess = getQueryParam('edit');

  if (editSuccess === 'success') {
    Swal.fire({
      icon: 'success',
      title: '¡Producto editado!',
      text: 'El producto se actualizó correctamente.',
      timer: 2000,
      showConfirmButton: false
    }).then(() => {
      // Opcional: Remover query string para que no aparezca de nuevo si recargas
      const url = new URL(window.location);
      url.searchParams.delete('edit');
      window.history.replaceState({}, document.title, url.toString());
    });
  }
    </script>

    <!-- Script Eliminar Productos Alert--> 

    <script>
    document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // Detener el envío

      Swal.fire({
        title: '¿Estás seguro?',
        text: '¡Esta acción eliminará el producto!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit(); // Enviar el formulario si confirma
        }
      });
    });
  });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
